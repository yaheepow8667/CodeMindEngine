# 前后端交互规范文档

## 1. 文档概述

本文档定义了智码引擎 AI驱动低代码开发平台的前后端交互规范，旨在确保前端与后端之间的通信高效、一致、可维护。所有前后端开发人员必须严格遵守本规范进行开发工作。

## 2. 基础规范

### 2.1 API版本管理
- API版本号格式：`v{主版本号}`，如 `v1`
- 版本号位置：URL路径中，如 `/api/v1/teams`
- 版本变更策略：
  - 不兼容的API变更（如参数名称、数据结构、返回格式变更）需升级主版本号
  - 兼容的API变更（如新增可选参数、新增字段）无需升级版本号

### 2.2 通信协议
- 所有API接口必须使用 `HTTPS` 协议进行通信
- API请求方法必须遵循RESTful设计原则：
  - `GET`：获取资源
  - `POST`：创建资源
  - `PUT`：更新资源（全量更新）
  - `PATCH`：更新资源（部分更新）
  - `DELETE`：删除资源

### 2.3 数据格式
- 请求和响应数据必须使用 `JSON` 格式
- 字符编码必须为 `UTF-8`
- JSON字段命名规范：使用 `snake_case`（下划线分隔）格式

## 3. 请求规范

### 3.1 请求URL格式
- 基础URL：`/api/v{版本号}`
- 资源路径：使用名词复数形式，如 `/api/v1/teams`、`/api/v1/projects`
- 示例：
  ```
  GET /api/v1/teams
  POST /api/v1/projects
  PUT /api/v1/blueprints/123
  ```

### 3.2 请求头
| 头部字段 | 必选 | 说明 | 示例值 |
|---------|------|------|--------|
| Content-Type | 是 | 请求体内容类型 | application/json |
| Authorization | 是 | 认证令牌 | Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... |
| X-Request-Id | 否 | 请求唯一标识，用于日志跟踪 | 550e8400-e29b-41d4-a716-446655440000 |
| Accept-Language | 否 | 语言偏好 | zh-CN,zh;q=0.9,en;q=0.8 |

### 3.3 请求参数
- **查询参数**：用于过滤、排序、分页等操作，如 `?page=1&limit=10&sort_by=created_at&order=desc`
- **路径参数**：用于标识资源ID，如 `/api/v1/teams/{team_id}`
- **请求体**：用于创建或更新资源的详细数据

#### 3.3.1 分页参数规范
| 参数名 | 类型 | 说明 | 默认值 |
|-------|------|------|--------|
| page | int | 页码 | 1 |
| limit | int | 每页条数 | 10 |
| sort_by | string | 排序字段 | created_at |
| order | string | 排序方向（asc/desc） | desc |

### 3.4 请求示例
```http
POST /api/v1/teams HTTP/1.1
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "name": "开发团队",
  "description": "负责智码引擎核心功能开发",
  "member_ids": [1, 2, 3]
}
```

## 4. 响应规范

### 4.1 响应格式
所有API响应必须遵循统一的格式：

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    // 响应数据
  }
}
```

#### 4.1.1 分页响应格式
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "items": [
      // 数据列表
    ],
    "total": 100,
    "page": 1,
    "limit": 10,
    "pages": 10
  }
}
```

### 4.2 响应码定义
| 响应码 | 说明 | 业务含义 |
|-------|------|----------|
| 200 | OK | 操作成功 |
| 201 | Created | 资源创建成功 |
| 204 | No Content | 操作成功但无返回数据 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未认证或认证失败 |
| 403 | Forbidden | 无权限访问 |
| 404 | Not Found | 资源不存在 |
| 405 | Method Not Allowed | 请求方法不允许 |
| 429 | Too Many Requests | 请求过于频繁 |
| 500 | Internal Server Error | 服务器内部错误 |
| 502 | Bad Gateway | 网关错误 |
| 503 | Service Unavailable | 服务不可用 |
| 504 | Gateway Timeout | 网关超时 |

### 4.3 业务错误码
业务错误码需在 `msg` 字段中详细说明，示例：

```json
{
  "code": 400,
  "msg": "团队名称已存在",
  "data": null
}
```

## 5. 错误处理机制

### 5.1 前端错误处理
- 统一捕获API请求错误
- 根据错误码给出友好的用户提示
- 对于401错误，自动跳转到登录页面
- 对于500错误，提示用户联系管理员
- 记录详细的错误日志，便于排查问题

### 5.2 后端错误处理
- 统一捕获异常并返回标准错误格式
- 详细记录错误日志，包括请求参数、错误堆栈等信息
- 避免返回敏感错误信息给前端
- 提供适当的重试机制（如幂等性设计）

## 6. 安全规范

### 6.1 认证与授权
- 使用JWT进行身份认证
- 认证信息必须放在请求头的 `Authorization` 字段中
- 实现RBAC（基于角色的权限控制）
- 敏感接口必须进行权限校验

### 6.2 数据安全
- 敏感数据传输前必须加密
- 密码等敏感信息必须进行哈希处理后存储
- 防止SQL注入、XSS攻击等常见安全问题
- 实现请求频率限制，防止暴力攻击

### 6.3 CORS配置
- 正确配置CORS策略，限制允许的来源、方法和头部
- 示例：
  ```python
  origins = [
      "http://localhost:3000",
      "https://dev.codemindengine.com",
      "https://codemindengine.com"
  ]
  ```

## 7. 性能优化

### 7.1 请求优化
- 减少HTTP请求次数，合并相关请求
- 使用合适的HTTP缓存策略
- 对于大数据量的响应，实现分页查询

### 7.2 响应优化
- 只返回必要的字段，避免传输冗余数据
- 对于大字段（如蓝图内容），考虑延迟加载或分块传输
- 使用gzip等压缩技术减少传输数据量

## 8. 文件上传与下载

### 8.1 文件上传
- 使用 `multipart/form-data` 格式
- 限制文件大小和类型
- 返回文件URL或ID供后续使用

### 8.2 文件下载
- 提供文件下载链接
- 支持断点续传（可选）
- 正确设置Content-Type和Content-Disposition头部

## 9. 接口文档

- 所有API接口必须使用OpenAPI 3.0规范编写文档
- 使用Swagger UI或ReDoc等工具生成可视化文档
- 文档必须包含：
  - 接口描述
  - 请求参数（包括类型、是否必填、默认值）
  - 响应格式（包括成功和失败的情况）
  - 示例请求和响应

## 10. 开发与测试

### 10.1 开发环境配置
- 前端开发环境：`http://localhost:3000`
- 后端开发环境：`http://localhost:8000`
- API基础路径：`/api/v1`

### 10.2 接口测试
- 前端开发人员必须使用Postman或curl等工具测试API接口
- 后端开发人员必须编写单元测试和集成测试
- 所有接口必须通过测试后才能上线

## 11. 变更管理

- API接口的变更必须遵循变更管理流程
- 变更前必须通知相关开发人员
- 重大变更必须经过技术评审
- 变更后必须更新接口文档

## 12. 附录

### 12.1 常见错误码表
| 错误码 | 错误信息 | 解决方案 |
|-------|----------|----------|
| 40001 | 团队名称已存在 | 更换其他团队名称 |
| 40002 | 项目名称已存在 | 更换其他项目名称 |
| 40003 | 蓝图内容不能为空 | 请填写蓝图内容 |
| 40101 | Token已过期 | 重新登录获取新Token |
| 40102 | Token无效 | 检查Token格式是否正确 |
| 40301 | 无团队管理权限 | 联系管理员获取权限 |
| 40401 | 团队不存在 | 检查团队ID是否正确 |
| 50001 | AI模型调用失败 | 稍后重试或联系管理员 |

### 12.2 数据类型映射表
| 前端类型 | 后端类型 | 说明 |
|---------|---------|------|
| string | str | 字符串 |
| number | int/float | 数字 |
| boolean | bool | 布尔值 |
| array | list | 数组 |
| object | dict | 对象 |
| null | None | 空值 |

---

**文档版本**：v1.0
**制定日期**：2025-12-16
**更新日期**：2025-12-16
**审核人**：技术负责人